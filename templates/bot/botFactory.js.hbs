/*
 * @author wingbot.ai
 */
'use strict';

const { Router{{#unless withoutDesigner}}, BuildRouter{{/unless}}{{#unless withoutDesigner}}, ai{{/unless}} } = require('wingbot');
{{#if botService}}
const { botServiceQuickReplyPatch } = require('wingbot-botservice');
{{/if}}
{{#if fbLoadProfile}}
const { userLoader } = require('wingbot-facebook');
{{/if}}
const config = require('../config');
{{#unless withoutDesigner}}
const plugins = require('./plugins');
{{#unless awsServerless}}
const configStorage = require('../lib/botConfigStorage');
{{/unless}}

ai.register(config.wingbot.ai);
{{/unless}}

function botFactory () {
{{#if withoutDesigner}}
    const bot = new Router();
{{else}}
    const routerOptions = {
{{#if analytics}}
        linksTranslator (senderId, linkText, linkUrl) {
            const url = encodeURIComponent(linkUrl);
            const text = encodeURIComponent(linkText);
            const sender = encodeURIComponent(senderId);
            return `${config.apiUrl}/tracker?url=${url}&text=${text}&sender=${sender}`;
        }{{/if}}{{#unless awsServerless}},
        configStorage{{/unless}}
    };
    const bot = new BuildRouter(config.wingbot, plugins, routerOptions);
{{/if}}

{{#if botService}}
    bot.use(botServiceQuickReplyPatch(bot, 'start'));

{{/if}}
{{#if fbLoadProfile}}
    // load user profile from Facebook
    bot.use(userLoader(config.facebook.pageToken));

{{/if}}
    // store previous action for analytics purposes
    bot.use((req, res) => {
        const action = req.action();
        if (action) {
            res.setState({ previousAction: action });
        }
        return Router.CONTINUE;
    });

    // attach router middlewares here

    return bot;
}

module.exports = botFactory;
